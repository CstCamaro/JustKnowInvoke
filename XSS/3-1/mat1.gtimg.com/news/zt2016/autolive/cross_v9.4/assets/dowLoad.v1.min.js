var host = {
    brower: function () {
        var brower, patternBrower, resultBrower, ua;
        ua = navigator.userAgent;
        patternBrower = /MicroMessenger|QQLiveBrowser|qqvideobrower|QQ\/|qqnews/gi;
        resultBrower = patternBrower.exec(ua);
        if (resultBrower != null) {
            switch (resultBrower[0].toLowerCase()) {
                case 'micromessenger':
                    brower = 'wx';
                    break;
                case 'qqlivebrowser':
                case 'qqvideobrower':
                    brower = 'videoapp';
                    break;
                case 'qqnews':
                    brower = 'newsapp';
                    break;
                case 'qq':
                    brower = 'qq';
                    break;
                default:
                    brower = 'html5'
            }
        } else {
            brower = 'html5'
        }
        this.brower = function () {
            return brower
        };
        return brower
    },
    system: function () {
        var patternSystem, resultSystem, system, ua;
        ua = navigator.userAgent;
        patternSystem = /iPhone|Android/gi;
        resultSystem = patternSystem.exec(ua);
        if (resultSystem != null) {
            switch (resultSystem[0].toLowerCase()) {
                case 'iphone':
                    system = 'ios';
                    break;
                case 'android':
                    system = 'android';
                    break;
                default:
                    system = 'html5'
            }
        } else {
            system = 'html5'
        }
        this.system = function () {
            return system
        };
        return system
    }
};
var brower = host.brower();
var system = host.system();
var isIos = system == "ios";
var qqnewsDown = {
    iosScheme: "qqnews://article_9500",
    androidPackageName: "com.tencent.news",
    downloadUrl: "http://view.inews.qq.com/newsDownLoad?refer=biznew&src=2142H5zt&by=dict",
    init: function () {
        var _this = this;
        if (brower == "newsapp") {
            $("#download_qqnews").hide()
        } else {
            $("#download_qqnews").show();
            if (brower == "wx") {
                function getInstallState () {
                    WeixinJSBridge.invoke("getInstallState", {
                        "packageUrl": _this.iosScheme,
                        "packageName": _this.androidPackageName
                    }, function (res) {
                        if (res && res.err_msg && res.err_msg.indexOf("get_install_state:yes") >= 0) {
                            _this.installed()
                        } else {
                            _this.uninstalled()
                        }
                    })
                }
                if (typeof WeixinJSBridge == "object" && typeof WeixinJSBridge.invoke == "function") {
                    getInstallState()
                } else {
                    if (document.addEventListener) {
                        document.addEventListener("WeixinJSBridgeReady", getInstallState, false)
                    } else if (document.attachEvent) {
                        document.attachEvent("WeixinJSBridgeReady", getInstallState);
                        document.attachEvent("onWeixinJSBridgeReady", getInstallState)
                    }
                }
            } else if (brower == "qq") {
                $.getScript("http://open.mobile.qq.com/sdk/qqapi.js?_bid=152", function () {
                    var value = isIos ? _this.iosScheme : _this.androidPackageName;
                    mqq.app.isAppInstalled(value, function (result) {
                        if (result) {
                            _this.installed()
                        } else {
                            _this.uninstalled()
                        }
                    })
                })
            } else {
                _this.otherInit();
                $("#download_qqnews").addClass('open')
            }
        }
    },
    //* 宸插畨瑁� QQNews 鎵ц鎷夎捣鎿嶄綔
    installed: function () {
        var _this = this;
        $("#download_qqnews").addClass('open');
        $("#download_qqnews").off().on("click", function () {
            _this.openSchemeApp(_this.iosScheme);
        })
    },
    openSchemeApp: function (scheme) {
        var _this = this;
        if (!scheme) { return; }
        var wxVersion = navigator.userAgent.toLowerCase().match(/micromessenger\/(\d+)\.(\d+)\.(\d+)/);
        var wxVerTag = 0;
        if (wxVersion && wxVersion.length >= 4) {
            wxVerTag = (parseInt(wxVersion[1]) * 100) + parseInt(wxVersion[2]) + (parseInt(wxVersion[3]) / 1000);
        }
        if (wxVerTag >= 605.006) {
            WeixinJSBridge.invoke("launchApplication", {
                "schemeUrl": scheme,
            }, function (res) {
                if ('launchApplication:ok' === res.err_msg) {
                } else if ('launchApplication:fail' === res.err_msg) {
                }
            });
        } else {
            window.location.href = scheme;
        }
    },
    //* 鏈畨瑁� QQNews 鎵ц涓嬭浇鎿嶄綔
    uninstalled: function () {
        var _this = this;
        $("#download_qqnews").addClass('download');
        $("#download_qqnews").off().on("click", function () {
            window.location.href = _this.downloadUrl
        })
    },
    loadQQApi: function () {
        var head = document.getElementsByTagName('body')[0];
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = 'http://open.mobile.qq.com/sdk/qqapi.js?_bid=152';
        head.appendChild(script)
    },
    otherInit: function () {
        var _this = this;
        $("#download_qqnews").off().on("click", function () {
            var ifr = document.createElement('iframe');
            ifr.src = _this.iosScheme;
            ifr.style.display = "none";
            document.body.appendChild(ifr);
            var beginTime = new Date();
            timer = window.setTimeout(function () {
                var endTime = new Date();
                if (endTime.getTime() - beginTime.getTime() > 2010) {
                    return
                }
                window.location.href = _this.downloadUrl;
                document.body.removeChild(ifr)
            }, 2000)
        })
    }
};
$(function () {
    qqnewsDown.init()
});
(function () {
    var _getScript = function (url, callback) {
        var head = document.getElementsByTagName('head')[0],
            js = document.createElement('script');
        js.setAttribute('type', 'text/javascript');
        js.setAttribute('src', url);
        head.appendChild(js);
        var callbackFn = function () {
            if (typeof callback === 'function') {
                callback()
            }
        };
        if (document.all) {
            js.onreadystatechange = function () {
                if (js.readyState == 'loaded' || js.readyState == 'complete') {
                    callbackFn()
                }
            }
        } else {
            js.onload = function () {
                callbackFn()
            }
        }
    };
    if (Zepto) {
        $.getScript = _getScript
    }
})();/*  |xGv00|585f1b176ae113a119a44a8fa10368e7 */