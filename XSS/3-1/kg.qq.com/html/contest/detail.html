
<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>大赛 - 全民K歌</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0">
    <meta name="format-detection" content="telephone=no">
    <meta name="author" content="Tencent-ISUX-Music">
    <meta name="Copyright" content="Tencent">
    <meta name="keywords" content="大赛,合唱,一起唱,独唱,K歌,K歌软件,在线K歌,唱歌,唱K,手机KTV,手机K歌,手机K歌软件,练歌,练歌软件,微信K歌神器,手机K歌神器,K歌软件哪个好" />
    <meta name="description" content="全球首款熟人社交K歌应用，集合练歌模式、好友PK等特色功能，还能和好友互发弹幕互动，赶紧下载和小伙伴一起争夺擂主吧！" />
    <meta name="applicable-device" content="pc,mobile">
    <!--[if lte IE 8]><link href="//kg.qq.com/gtimg/mediastyle/kge_v2/ie8.css" rel="stylesheet" /><![endif]-->
    <script>
        if(/android|iphone|ipad|ipod/ig.test(navigator.userAgent)) {
            location.href = 'http://kg.qq.com/dasai/detail.html' + location.search;
        }
    </script>
<link href="//kg.qq.com/gtimg/mediastyle/kge_v2/act_detail.css" rel="stylesheet" />
<style type="text/css">
.text-link{
    text-decoration: underline;
    color:#e95f55;
    padding:0 2px;
}
</style>
</head>
<body>
<!--头部 S-->
<div class="mod_bar js_kg_head">
</div>
<!--头部 E-->
<!--导航 S-->
<div class="mod_nav js_kg_nav" data-navIndex=2>
</div>
<!--导航 E-->
<!--主要内容 S-->
<div class="mod_wrap">
    <!--活动概况 S-->
    <div class="act_show j_detail_pic">
        
    </div>
    <div class="act_info j_detail_intro">
        
        <!--<div class="act_info__join"><a href="javascript:" class="btn_strong" title="下载app参赛"><span class="icon_mike"></span> 下载APP参赛</a></div>-->
    </div>
    <!--活动概况 E-->
    <!--活动详情 S-->
    <div class="act_detail clear_fix">
        <div class="mod_title clear_fix">
            <h2 class="mod_title__name"><span class="mod_title__bar"></span> 活动详情</h2>
        </div>
        <div class="act_detail__info j_detail_info act_detail__info--up"><!--展开去掉样式act_detail__info--up-->
            
        </div>
    </div>
    <!--活动详情 E-->
</div>
<div class="mod_wrap clear_fix j_detail_wrap" style="display:none;">
    <!--排行榜 S-->
    <div class="mod_content">
        <div class="mod_title clear_fix">
            <h2 class="mod_title__name"><span class="mod_title__bar"></span> 排行榜</h2>
        </div>
        <ul class="mod_rank j_rank">
            
        </ul>
    </div>
    <!--排行榜 E-->
    <!--最新作品 S-->
    <div class="mod_sidebar">
        <div class="mod_title clear_fix">
            <h2 class="mod_title__name"><span class="mod_title__bar"></span> 最新作品</h2>
        </div>
        <div class="opus_show">
            <ul class="opus_list clear_fix j_news">
               
            </ul>
        </div>
    </div>
    <!--最新作品 E-->
    <div class="mod_more"><a href="javascript:;" class="btn_more j_more">查看更多</a></div>
    <div class="mod_up">
        <a href="javascript:void(0);" class="icon icon_up j_scrolltop">回到顶部</a>
    </div>
</div>
<!--主要内容 E-->
<!--尾部 S-->
<div class="mod_footer" id="frame_bottom">
    <!--这里是底部版权信息等，这里的内容由JS生成-->
</div>
<div class="qui_dialog__mask mask" style="display:none;"></div>
<div class="qui_dialog__box qui_dialog__narrow j_phonenum_pop" style="display:none;top:50%;margin-top:-130px;">
    <div class="qui_dialog__hd">
        <h2 class="qui_dialog__tit">参赛手机号</h2>
        <a href="javascript:" class="qui_dialog__close j_close" title="关闭">关闭</a>
    </div>
    <div class="qui_dialog__bd">
        <div class="dialog_form">
            <label class="dialog_form__label"><input type="text" id="phonenum" maxlength="11" value="" name="" placeholder="请输入你的真实手机号码" class="dialog_form__input"></label>
            <p>请输入你的真实手机号码，我们将通过此号码与您取得联系。</p>
        </div>
    </div>
    <div class="qui_dialog__ft">
        <a href="javascript:" class="btn_strong j_submit_number btn--off" title="提交信息">提交信息</a>
    </div>
</div>
<!--尾部 E-->
<script src="//kg.qq.com/gtimg/music/js/lib/jquery-min.js?max_age=31104000000"></script>
<script type="text/javascript" src="//kg.qq.com/gtimg/music/kg/lib/sea-kg.js?max_age=31104000000"></script>
<script>
document.domain = 'qq.com';
//错误上报
seajs.config({
    base: '//kg.qq.com/gtimg/music/kg',
    timeout: 8000
});
var list = [
    '/gtimg/music/kg/lib/common.js',
    '/gtimg/music/kg/lib/user.js',
    '/gtimg/music/kg/lib/lazy.js'
]
document.write('<script type="text/javascript" charset="utf-8" src="\/\/kg.qq.com\/c\/='+ list.join(',') +'?max_age=31104000001"><\/script>');
</script>
<script>
define('main',function(require, exports, module){
    var user = require('lib/user');
    var common = require('lib/common');
    var lazy = require('lib/lazy');

    var status = {
        1: '即将开始', 2: '立即参赛', 3: '活动已结束'
    };

    exports = module.exports = {
        init:function(){
            user.init({redirectUrl: window.location.href});
            this.get();
            this.bind();
            //pv上报
            common.pv();
        },
        data : {},
        param : {
            id : common.getParameter('id'),
            rank_index : 0,
            news_index : 0,
            rank_per_num : 5,
            news_per_num : 4,
            uploadid: ''
        },
        get : function(){
            if(exports.param.id > 5000000){
                common.ajax({
                    url : 'http://kg.qq.com/cgi/fcg_get_contest_detail',
                    dataType : 'json',
                    data : {
                        'id': exports.param.id,
                        format : 'json'
                    },
                    success : function(res){
                        exports.data.detail = res.data;

                        var html = '';
                        html += '<div class="act_show__img"><img src="'+common.parseUrlHttps(res.data.detail.picture)+'" alt="" /><span class="corner_match"></span></div>';
                        html += '<div class="act_show__code">';
                        html += '    <img class="act_code__img" src="'+common.parseUrlHttps('http://node.kg.qq.com/qrcode?' + $.param({
                            width : 130,
                            margin : 1,
                            eclevel : 'm',
                            encode : 1,
                            url : 'http://kg.qq.com/dasai/detail.html?id='+exports.param.id
                        })) + ' alt="大赛二维码" >';
                        html += '    <p class="act_code__txt">手机扫一扫，立即参赛</p>';
                        html += '</div>';
                        html += '<div class="act_show__bg"><img src="'+common.parseUrlHttps(res.data.detail.picture)+'" alt="" /></div>';
                        $('.j_detail_pic').html(html);

                        var html = '';
                        html +=' <dl class="act_detail__list">';
                        html +='     <dt>时间：</dt>';
                        html +='     <dd>' + res.data.detail.stat_time + '至' + res.data.detail.end_time + '</dd>';
                        html +='     <dt>声明：</dt>';
                        html +='     <dd>'+res.data.statement+'</dd>';
                        if (res.data.detail.member) {
                            html +='     <dt>对象：</dt>';
                            html +='     <dd>'+res.data.detail.member+'</dd>';
                        }
                        html +='     <dt>简介：</dt>';
                        html +='     <dd>'+res.data.detail.introduce+'</dd>';
                        if (res.data.detail.prize.length > 0) {
                            html +='     <dt>奖品：</dt>';
                            html +='     <dd>'+res.data.detail.prize+'</dd>';
                        }
                        html +='     <dt>规则：</dt>';
                        html +='     <dd>'+res.data.detail.rule+'</dd>';
                        html +=' </dl>';
                        html +=' <a href="javascript:;" class="act_detail__more j_detail_more">详情 <i class="icon icon_add"></i></a>';
                        $('.j_detail_info').html(html);

                        var html = '';
                        html += '<p class="act_info__title">'+res.data.detail.name+'</p>';
                        html += '<p class="act_info__txt">'+exports.replaceWrap(res.data.detail.introduce)+'</p>';
                        $('.j_detail_intro').html(html);

                    },
                    error : function(){

                    }
                })
            }else{
                common.ajax({
                    url : 'http://cgi.kg.qq.com/fcgi-bin/fcg_get_rule',
                    jsonp : 'callback',
                    jsonpCallback : 'callback', 
                    data : {
                        'actid': exports.param.id
                    },
                    success : function(res){
                        if(res.subcode == -1){
                            $('.j_detail_pic').html('<div class="act_show__code" style="right:45%;"><img class="act_code__img" src="'+common.parseUrlHttps('http://node.kg.qq.com/qrcode?' + $.param({
                                width : 130,
                                margin : 1,
                                eclevel : 'm',
                                encode : 1,
                                url : 'http://kg.qq.com/dasai/detail.html?id='+exports.param.id
                            })) + '">'+ 
                            '<p class="act_code__txt">手机扫一扫，立即参赛</p></div>');
                            $('.j_detail_intro').html('<p class="act_info__tips">该比赛为内部大赛，请扫描上面的二维码登录K歌客户端查看是否有权限！</p>');
                        }else{
                            exports.data.detail = res.activity_rule;
                            
                            exports.param.uploadid = common.getParameter('uploadid', res.activity_rule.url);//成品大赛
                            var needinvited = res.activity_rule.status == 2 && res.activity_rule.inWhiteList == 0;

                            var btn_name = status[res.activity_rule.status];

                            var html = '';
                            html += '<div class="act_show__img"><img src="'+common.parseUrlHttps(res.activity_rule.picture_rul)+'" alt="" /></div>';
                            html += '<div class="act_show__code" '+ (res.activity_rule.support_orignal ?  'style="display:none;"' : '')+'>';
                            html += '    <img class="act_code__img" src="'+common.parseUrlHttps('http://node.kg.qq.com/qrcode?' + $.param({
                                width : 130,
                                margin : 1,
                                eclevel : 'm',
                                encode : 1,
                                url : res.activity_rule.url && res.activity_rule.url.length > 7 ? res.activity_rule.url : 'http://kg.qq.com/dasai/detail.html?id='+exports.param.id
                            })) + '" alt="大赛二维码" >';
                            html += '    <p class="act_code__txt">手机扫一扫，立即参赛</p>';
                            html += '</div>';
                            res.activity_rule.support_orignal && (html += '<div class="act_show__join"><a href="javascript:;" class="btn_join_act j_join_act '+ (res.activity_rule.status == 1 ? 'btn--wait disable' : res.activity_rule.status == 3 ? 'btn--off disable' : '') +'">'+btn_name+'</a><a href="javascript:;" class="ui_c_primary j_phonenum" style="display:none;">查看参赛手机号&gt;</a></div>');
                            html += '<div class="act_show__bg"><img src="'+common.parseUrlHttps(res.activity_rule.picture_rul)+'" alt="" /></div>';
                            $('.j_detail_pic').html(html);

                            var html = '';
                            html +=' <dl class="act_detail__list">';
                            html +='     <dt>活动时间</dt>';
                            html +='     <dd>'+res.activity_rule.detail.time+'&nbsp;</dd>';
                            html +='     <dt>活动要求</dt>';
                            html +='     <dd>'+exports.replaceWrap(res.activity_rule.detail.rule)+'&nbsp;</dd>';
                            html +='     <dt>评选规则</dt>';
                            html +='     <dd>'+exports.replaceWrap(res.activity_rule.detail.choose)+'&nbsp;</dd>';
                            html +='     <dt>其&emsp;&emsp;他</dt>';
                            html +='     <dd>'+exports.replaceWrap(res.activity_rule.detail.other)+'&nbsp;</dd>';
                            html +=' </dl>';
                            html +=' <a href="javascript:;" class="act_detail__more j_detail_more">详情 <i class="icon icon_add"></i></a>';
                            $('.j_detail_info').html(html);

                            var html = '';
                            html += '<p class="act_info__title">'+res.activity_rule.name+'</p>';
                            html += '<p class="act_info__txt">'+exports.replaceWrap(res.activity_rule.introduce)+'</p>';
                            html += '<ul class="act_info__prize">';
                            for(var i = 0, item; item = res.activity_rule.detail.vec_prize[i]; i++){
                                if(item.picture == 'http://imgcache.qq.com/music/common'){continue}
                                html += '    <li class="act_prize__item">';
                                html += '        <p class="act_prize__img"><img src="'+common.parseUrlHttps(item.picture)+'" alt="" ></p>';
                                html += '        <p class="act_prize__name">'+item.name+'</p>';
                                html += '    </li>';
                            }
                            html += '</ul>';
                            $('.j_detail_intro').html(html);

                            if(res.activity_rule.status > 1){
                                exports.getRank();
                                exports.getNews();
                            }
                            if(res.activity_rule.status == 2 && exports.isLogin()){
                                exports.getPhone();
                            }
                        }
                    },
                    error : function(){
                        
                    }
                })
            }
        },
        replaceWrap:function (str) {//替换\r\n换行和自定义链接
            return str
                .replace(/(\r\n)|\n|(\&lt;br\&gt;)/ig,"<br>")
                .replace(/\[([^\]]+)\|([^\]]+)\]/ig, function(_, $1, $2){
                    return '<a class="text-link" href="'+$2+'" >'+$1+'</a>';
                });
        },
        isLogin(){
            return common.getCookie('openid') && common.getCookie('openkey')
        },
        getRank : function(){
            common.ajax({
                url: 'http://cgi.kg.qq.com/fcgi-bin/fcg_get_rank',
                jsonp : 'callback',
                data: {  
                    'type': 'rank',
                    'actid': exports.param.uploadid || exports.param.id,
                    'index': exports.param.rank_index,
                    'per_num': exports.param.rank_per_num
                },            
                success: function(res) {            
                    var html = '', list = res.ranklist || res.list;
                    function formatNum(num){
                        var str = '';
                        str = num < 1000000 ? num : (num < 100000000 ? Math.floor(num / 10000) + '万' : Math.floor(num / 100000000) +'亿+');
                        return str;
                    }
                    if(list && list.length){
                        for(var i = 0, item; item = list[i]; i++){
                            html += '<li class="mod_rank__item">';
                            html += '    <a href="http://kg.qq.com/share.html?s='+(item.ugc.shareid ? item.ugc.shareid : item.shareid)+'" target="_blank" class="mod_rank__show">';
                            html += '        <div class="mod_rank__num ' + (exports.param.rank_index + i < 3 ? 'icon_top' + (i + 1) : '') + '">' +(exports.param.rank_index + i + 1)+ '</div>';
                            html += '        <div class="mod_rank__img"><i class="icon icon_play_b"></i><img  data-lazyload="'+item.anthor.head_url+'" src="//kg.qq.com/gtimg/music/musicbox_v3/img/pics/default.gif" alt=""></div>';
                            html += '        <div class="mod_rank__txt">';
                            html += '            <p class="mod_rank__song">'+item.ugc.songname+'</p>';
                            html += '            <p class="mod_rank__singer">'+common.parseEmoji(item.anthor.nickname)+'</p>';
                            html += '        </div>';
                            html += '        <div class="mod_rank__count" style="'+(res.rank_type && res.rank_type == 8 ? 'display:none;' : '')+'">'
                                if(res.ranktype == 2 || exports.data.detail.rank_type == 2 ){
                                    html +=     '<i class="icon icon_flower"></i>' + formatNum(item.ugc.flower_num)
                                }else if(res.ranktype == 6){
                                    html +=     '<i class="icon icon_kb"></i> ' + formatNum(item.ugc.xingzuan_num)
                                }else {
                                    html +=     '<i class="icon icon_hot"></i> ' + formatNum(item.ugc.hot_score)
                                }
                            html += '       </div>';
                            html += '    </a>';
                            html += '</li>';
                        }
                        $('.j_rank').append(html);
                        $('.j_detail_wrap').show();
                        lazy.load();
                    }
                    exports.param.rank_index += exports.param.rank_per_num;
                    if (exports.param.rank_index >= res.total) {
                        $('.j_more').hide();
                    }
                }
            });
        },
        getNews : function(){
            common.ajax({
                url: 'http://cgi.kg.qq.com/fcgi-bin/fcg_get_rank',
                jsonp : 'callback',
                data: {  
                    'type': 'newer',
                    'actid': exports.param.uploadid || exports.param.id,
                    'index': exports.param.news_index,
                    'per_num': exports.param.news_per_num
                },        
                success: function (res) {
                    exports.param.news_index += exports.param.news_per_num;
                    var html = '', list = res.ranklist || res.list;
                    if(list && list.length){
                        for(var i = 0, item; item = list[i]; i++){
                            //作品类型
                            var mask = (item.ugc_mask & 0x01) ? 'mv' : (item.ugc_mask & 0x8000 || item.ugc_mask & 0x4000 || item.ugc_mask & 0x2000) ? 'hc' : (item.ugc_mask & 0x20000) ? 'qc' : '';

                            html += '<li class="opus_list__item">';
                            html += '    <a href="http://kg.qq.com/share.html?s='+item.ugc.shareid+'" target="_blank" class="opus_list__show opus_list__show--current">';
                            html += '        <div class="opus_list__img"><img  data-lazyload="'+item.anthor.head_url+'" src="//kg.qq.com/gtimg/music/musicbox_v3/img/pics/default.gif" alt=""></div>';
                            html += '        <div class="opus_list__mask"></div>';
                            html += '        <div class="opus_list__count">';
                            html += '            <span class="opus_list__icon icon icon_play_s"></span>';
                            html += '            <p class="opus_list__song">'+item.ugc.songname+'</p>';
                            html += '            <p class="opus_list__listen"><span class="icon icon_listen"></span>'+item.ugc.watch_num+'</p>';
                            html += '            <p class="opus_list__name">'+common.parseEmoji(item.anthor.nickname)+'</p>';
                            html += '        </div>';
                            html += '        <span class="corner corner_'+mask+'"></span>';
                            html += '    </a>';
                            html += '</li>';
                        }
                        $('.j_news').append(html);
                        $('.j_detail_wrap').show();
                        lazy.load();
                    }
                }
            });
        },
        getPhone: function(){
            if(exports.phoneinfo){
                return;
            }
            common.ajax({
                url: 'http://cgi.kg.qq.com/fcgi-bin/' + (exports.param.uploadid ? 'fcg_star_road' : 'fcg_mobile_phone') ,
                jsonp : 'callback',
                jsonpCallback: 'MusicJsonCallback',
                data: exports.param.uploadid ? {method: 'registQuery', contestid: exports.param.uploadid} :{
                    type:'get',
                    actid: exports.param.id
                },
                success: function(res){
                    if(res.subcode != -32302 && !exports.phoneInfo){
                        exports.phoneInfo = exports.param.uploadid ? $.extend(res.data, {phoneNum: res.data.phone || ''}) : res;
                    }
                    var isRegisted = res.phoneNum || res.data && res.data.bRegisted;
                    
                    if(isRegisted){
                        $('.j_phonenum').show();
                        $('#phonenum').attr('value', res.phoneNum || res.data && res.data.phone || '');
                        $('.j_submit_number').removeClass('btn--off').addClass('btn--on');
                    }
                }
            })
        },
        savePhone: function(phonenum){
            if(!phonenum) return;
            common.ajax({
                url: 'http://cgi.kg.qq.com/fcgi-bin/'+(exports.param.uploadid ? 'fcg_star_road' : 'fcg_mobile_phone'),
                jsonp : 'callback',
                jsonpCallback: 'MusicJsonCallback',
                data: exports.param.uploadid ? {method: 'regist', contestid: exports.param.uploadid, phone: phonenum} : {
                    type:'set',
                    phonenum: phonenum,
                    actid: exports.param.id
                },
                success: function(res){
                    exports.phoneInfo = {phoneNum: phonenum, is_sign: 1};
                    $('.j_join_act').trigger('click');
                }
            })
        }, 
        bind : function (){
            $(document.body).on('click', '.j_more', function(){
                exports.getNews();
                exports.getRank();
                return false;
            })
            .on('click', '.j_detail_more', function(){
                $('.j_detail_info').toggleClass('act_detail__info--up');
                $(this).find('.icon').toggleClass('icon_sub');
                return false;
            })
            .on('click', '.j_scrolltop', function(){
                $(window).scrollTop(0)
                return false;
            })
            .on('click', '.j_join_act', function(){
                if($(this).hasClass('disable')){
                    return;
                }
                if(!exports.isLogin()){
                    user.login();
                    return;
                }
                if(!exports.data.detail){
                    return;
                }
                
                if(!exports.phoneInfo || !exports.phoneInfo.phoneNum){//没电话号码
                    $('.mask').show();
                    $('.j_phonenum_pop').show();
                    return;
                }
                window.location.href = 'http://kg.qq.com/html/contest/work_upload.html?activityid='+ (exports.param.uploadid || exports.param.id) + '&from=pcdasai&isxingtu='+(exports.param.uploadid ? '1' : '');

            })
            .on('click', '.j_phonenum', function(){
                
                $('.mask').show();
                $('.j_phonenum_pop').show();
            })
            .on('click', '.j_submit_number', function(){
                var value = $.trim($('#phonenum')[0].value);
                if(!value || $(this).hasClass('btn--off') || !/^\d{11}$/.test(value)){
                    return;
                }
                exports.savePhone(value);
            })
            .on('click', '.qui_dialog__close', function(){
                $('.mask').hide();
                $('.j_phonenum_pop').hide();
                $('#phonenum')[0].value = exports.phoneInfo.phoneNum;
            })

            $('#phonenum').on('input', function(){
                var el = $(this)[0];
                el.value = el.value.replace(/[^\d]/g, '');
                if(el.value == ''){
                    $('.j_submit_number').removeClass('btn--on').addClass('btn--off')
                } else {
                    $('.j_submit_number').removeClass('btn--off').addClass('btn--on')
                }
            })
        }
    }
    exports.init();
});

seajs.use('main');
</script>
<!--[if IE 6]><script type="text/javascript" src="//kg.qq.com/gtimg/mediastyle/kge_v2/sprite/DD_belatedPNG_0.0.8a.js"></script><![endif]-->
</body>
</html>